name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  windows-mingw:
    name: Windows (MSYS2 GCC)
    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            mingw-w64-x86_64-gcc
            mingw-w64-x86_64-cmake
            mingw-w64-x86_64-ninja
            mingw-w64-x86_64-vulkan-devel
            mingw-w64-x86_64-shaderc

      - name: Bootstrap vcpkg
        run: ./vcpkg/bootstrap-vcpkg.sh

      - name: Configure
        env:
          VCPKG_DEFAULT_TRIPLET: x64-mingw-dynamic
        run: >-
          cmake -B build -S .
          -DCMAKE_TOOLCHAIN_FILE=vcpkg/scripts/buildsystems/vcpkg.cmake
          -DVCPKG_TARGET_TRIPLET=x64-mingw-dynamic
          -G Ninja

      - name: Build
        run: cmake --build build

      - name: Unit tests
        run: >-
          ctest --test-dir build --output-on-failure
          -R "test_error|test_result|test_projection|test_transform"

  linux:
    name: Linux (${{ matrix.compiler }})
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        include:
          - compiler: gcc
            cc: gcc-14
            cxx: g++-14
          - compiler: clang
            cc: clang-18
            cxx: clang++-18
    env:
      CC: ${{ matrix.cc }}
      CXX: ${{ matrix.cxx }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Vulkan SDK
        run: |
          wget -qO- https://packages.lunarg.com/lunarg-signing-key-pub.asc | sudo tee /etc/apt/trusted.gpg.d/lunarg.asc
          sudo wget -qO /etc/apt/sources.list.d/lunarg-vulkan-noble.list http://packages.lunarg.com/vulkan/lunarg-vulkan-noble.list
          sudo apt-get update
          sudo apt-get install -y vulkan-sdk

      - name: Install build tools and system libraries
        run: >-
          sudo apt-get install -y
          build-essential cmake ninja-build
          autoconf autoconf-archive automake libtool pkg-config
          libltdl-dev
          libasound2-dev libpulse-dev libpipewire-0.3-dev
          libx11-dev libxext-dev libxrandr-dev libxcursor-dev
          libxfixes-dev libxi-dev libxss-dev libxkbcommon-dev
          libdrm-dev libgbm-dev libgl1-mesa-dev libgles2-mesa-dev
          libegl1-mesa-dev libdbus-1-dev libibus-1.0-dev
          libudev-dev libdecor-0-dev libwayland-dev

      - name: Bootstrap vcpkg
        run: ./vcpkg/bootstrap-vcpkg.sh

      - name: Configure
        run: >-
          cmake -B build -S .
          -DCMAKE_TOOLCHAIN_FILE=vcpkg/scripts/buildsystems/vcpkg.cmake
          -G Ninja

      - name: Build
        run: cmake --build build

      - name: Unit tests
        run: >-
          ctest --test-dir build --output-on-failure
          -R "test_error|test_result|test_projection|test_transform"
