name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

env:
  VULKAN_SDK_VER: "1.4.304.0"

jobs:
  # ── Fast check: compile & validate all GLSL shaders ────────────────
  shader-validation:
    name: Shader Validation
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4

      - name: Install Vulkan SDK
        uses: jakoch/install-vulkan-sdk-action@v1
        with:
          vulkan_version: ${{ env.VULKAN_SDK_VER }}
          cache: true
          stripdown: true

      - name: Compile and validate shaders
        run: |
          set -euo pipefail
          FAILED=0
          while IFS= read -r -d '' f; do
            printf "  %-60s " "$f"
            if glslc --target-env=vulkan1.3 "$f" -o /tmp/shader.spv 2>&1; then
              if spirv-val /tmp/shader.spv 2>&1; then
                echo "ok"
              else
                echo "FAIL (spirv-val)"
                FAILED=1
              fi
            else
              echo "FAIL (glslc)"
              FAILED=1
            fi
          done < <(find examples tests -type f \( \
                     -name "*.vert" -o -name "*.frag" -o -name "*.comp" \
                     -o -name "*.rgen" -o -name "*.rmiss" -o -name "*.rchit" \
                   \) -print0 | sort -z)
          echo ""
          echo "---"
          if [ "$FAILED" -ne 0 ]; then
            echo "Shader validation failed."
            exit 1
          fi
          echo "All shaders compiled and validated."

  # ── Formatting gate (clang-format 18) ──────────────────────────────
  format-check:
    name: Format Check
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install clang-format
        run: >-
          sudo apt-get update && sudo apt-get install -y clang-format-18

      - name: Verify formatting
        env:
          CLANG_FORMAT_BIN: clang-format-18
          FORMAT_BASE_REF: HEAD~1
        run: bash scripts/clang-format.sh --check

  # ── Windows (MSYS2 UCRT64) ────────────────────────────────────────
  windows-ucrt:
    name: Windows (UCRT64)
    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}
    env:
      CCACHE_DIR: D:/ccache
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: msys2/setup-msys2@v2
        with:
          msystem: UCRT64
          update: true
          install: >-
            mingw-w64-ucrt-x86_64-gcc
            mingw-w64-ucrt-x86_64-cmake
            mingw-w64-ucrt-x86_64-ninja
            mingw-w64-ucrt-x86_64-vulkan-devel
            mingw-w64-ucrt-x86_64-shaderc
            mingw-w64-ucrt-x86_64-ccache

      - name: Restore ccache
        uses: actions/cache@v4
        with:
          path: D:/ccache
          key: ccache-ucrt64-${{ github.sha }}
          restore-keys: ccache-ucrt64-

      - name: Restore vcpkg packages
        uses: actions/cache@v4
        with:
          path: build/vcpkg_installed
          key: vcpkg-ucrt64-${{ hashFiles('vcpkg.json') }}
          restore-keys: vcpkg-ucrt64-

      - name: Bootstrap vcpkg
        run: ./vcpkg/bootstrap-vcpkg.sh

      - name: Configure
        run: >-
          cmake -B build -S .
          -G Ninja
          -DCMAKE_TOOLCHAIN_FILE=vcpkg/scripts/buildsystems/vcpkg.cmake
          -DVCPKG_TARGET_TRIPLET=x64-mingw-dynamic
          -DCMAKE_C_COMPILER_LAUNCHER=ccache
          -DCMAKE_CXX_COMPILER_LAUNCHER=ccache

      - name: Build
        run: cmake --build build

      - name: Unit tests
        run: >-
          ctest --test-dir build --output-on-failure
          -R "test_error|test_result|test_projection|test_transform"

      - name: ccache stats
        if: always()
        run: ccache --show-stats

  # ── Linux (GCC + Clang matrix, integration tests via Lavapipe) ────
  linux:
    name: Linux (${{ matrix.compiler }})
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: false
      matrix:
        include:
          - compiler: gcc-14
            cc: gcc-14
            cxx: g++-14
          - compiler: clang-18
            cc: clang-18
            cxx: clang++-18
    env:
      CC: ${{ matrix.cc }}
      CXX: ${{ matrix.cxx }}
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Vulkan SDK
        uses: jakoch/install-vulkan-sdk-action@v1
        with:
          vulkan_version: ${{ env.VULKAN_SDK_VER }}
          cache: true
          stripdown: true

      - name: Install system dependencies
        run: >-
          sudo apt-get update && sudo apt-get install -y
          build-essential ninja-build
          autoconf autoconf-archive automake libtool pkg-config libltdl-dev
          libasound2-dev libpulse-dev libpipewire-0.3-dev
          libx11-dev libxext-dev libxrandr-dev libxcursor-dev
          libxfixes-dev libxi-dev libxss-dev libxkbcommon-dev
          libdrm-dev libgbm-dev libgl1-mesa-dev libgles2-mesa-dev
          libegl1-mesa-dev libdbus-1-dev libibus-1.0-dev
          libudev-dev libdecor-0-dev libwayland-dev libxtst-dev
          mesa-vulkan-drivers xvfb

      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: linux-${{ matrix.compiler }}

      - name: Restore vcpkg packages
        uses: actions/cache@v4
        with:
          path: build/vcpkg_installed
          key: vcpkg-linux-${{ matrix.compiler }}-${{ hashFiles('vcpkg.json') }}
          restore-keys: vcpkg-linux-${{ matrix.compiler }}-

      - name: Bootstrap vcpkg
        run: ./vcpkg/bootstrap-vcpkg.sh

      - name: Configure
        run: >-
          cmake -B build -S .
          -G Ninja
          -DCMAKE_TOOLCHAIN_FILE=vcpkg/scripts/buildsystems/vcpkg.cmake
          -DCMAKE_C_COMPILER_LAUNCHER=ccache
          -DCMAKE_CXX_COMPILER_LAUNCHER=ccache

      - name: Build
        run: cmake --build build

      - name: Unit tests
        run: >-
          ctest --test-dir build --output-on-failure
          -R "test_error|test_result|test_projection|test_transform"

      - name: Integration tests (Lavapipe)
        continue-on-error: true
        timeout-minutes: 10
        run: >-
          xvfb-run ctest --test-dir build --output-on-failure
          -E "test_error|test_result|test_projection|test_transform"

  # ── macOS (C++20 build + non-window test subset) ───────────────────
  macos:
    name: macOS (AppleClang)
    runs-on: macos-14
    env:
      CC: clang
      CXX: clang++
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Vulkan SDK
        uses: jakoch/install-vulkan-sdk-action@v1
        with:
          vulkan_version: ${{ env.VULKAN_SDK_VER }}
          cache: true
          stripdown: true

      - name: Install system dependencies
        run: brew install ninja pkg-config

      - name: Restore vcpkg packages
        uses: actions/cache@v4
        with:
          path: build/vcpkg_installed
          key: vcpkg-macos-${{ hashFiles('vcpkg.json') }}
          restore-keys: vcpkg-macos-

      - name: Bootstrap vcpkg
        run: ./vcpkg/bootstrap-vcpkg.sh

      - name: Configure
        run: >-
          cmake -B build -S .
          -G Ninja
          -DCMAKE_TOOLCHAIN_FILE=vcpkg/scripts/buildsystems/vcpkg.cmake
          -DVKSDL_BUILD_EXAMPLES=OFF

      - name: Build
        run: cmake --build build

      - name: Non-window test subset
        run: >-
          ctest --test-dir build --output-on-failure
          -R "test_error|test_result|test_projection|test_transform|test_resource_state|test_barrier_compiler"

  # ── Strict warning lane (Linux, C++20, -Werror) ────────────────────
  strict-warnings:
    name: Strict Warnings
    runs-on: ubuntu-24.04
    env:
      CC: clang-18
      CXX: clang++-18
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Vulkan SDK
        uses: jakoch/install-vulkan-sdk-action@v1
        with:
          vulkan_version: ${{ env.VULKAN_SDK_VER }}
          cache: true
          stripdown: true

      - name: Install system dependencies
        run: >-
          sudo apt-get update && sudo apt-get install -y
          build-essential ninja-build clang-18
          autoconf autoconf-archive automake libtool pkg-config libltdl-dev
          libasound2-dev libpulse-dev libpipewire-0.3-dev
          libx11-dev libxext-dev libxrandr-dev libxcursor-dev
          libxfixes-dev libxi-dev libxss-dev libxkbcommon-dev
          libdrm-dev libgbm-dev libgl1-mesa-dev libgles2-mesa-dev
          libegl1-mesa-dev libdbus-1-dev libibus-1.0-dev
          libudev-dev libdecor-0-dev libwayland-dev libxtst-dev
          mesa-vulkan-drivers xvfb

      - name: Restore vcpkg packages
        uses: actions/cache@v4
        with:
          path: build/vcpkg_installed
          key: vcpkg-linux-strict-${{ hashFiles('vcpkg.json') }}
          restore-keys: vcpkg-linux-strict-

      - name: Bootstrap vcpkg
        run: ./vcpkg/bootstrap-vcpkg.sh

      - name: Configure
        run: >-
          cmake -B build -S .
          -G Ninja
          -DCMAKE_TOOLCHAIN_FILE=vcpkg/scripts/buildsystems/vcpkg.cmake
          -DVKSDL_STRICT_WARNINGS=ON
          -DVKSDL_WERROR=ON
          -DVKSDL_BUILD_EXAMPLES=OFF

      - name: Build
        run: cmake --build build

      - name: Unit tests
        run: >-
          ctest --test-dir build --output-on-failure
          -R "test_error|test_result|test_projection|test_transform"

  # ── Secondary static analysis (cppcheck) ───────────────────────────
  cppcheck:
    name: cppcheck
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install cppcheck
        run: >-
          sudo apt-get update && sudo apt-get install -y cppcheck

      - name: Run cppcheck
        run: >-
          cppcheck
          --std=c++20
          --enable=warning,performance,portability
          --error-exitcode=1
          --inline-suppr
          --suppress=missingIncludeSystem
          -I include
          src include

  # ── ASan + UBSan ──────────────────────────────────────────────────
  sanitizers:
    name: ASan + UBSan
    runs-on: ubuntu-24.04
    env:
      CC: clang-18
      CXX: clang++-18
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Vulkan SDK
        uses: jakoch/install-vulkan-sdk-action@v1
        with:
          vulkan_version: ${{ env.VULKAN_SDK_VER }}
          cache: true
          stripdown: true

      - name: Install system dependencies
        run: >-
          sudo apt-get update && sudo apt-get install -y
          build-essential ninja-build clang-18
          autoconf autoconf-archive automake libtool pkg-config libltdl-dev
          libasound2-dev libpulse-dev libpipewire-0.3-dev
          libx11-dev libxext-dev libxrandr-dev libxcursor-dev
          libxfixes-dev libxi-dev libxss-dev libxkbcommon-dev
          libdrm-dev libgbm-dev libgl1-mesa-dev libgles2-mesa-dev
          libegl1-mesa-dev libdbus-1-dev libibus-1.0-dev
          libudev-dev libdecor-0-dev libwayland-dev libxtst-dev
          mesa-vulkan-drivers xvfb

      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: linux-asan

      - name: Restore vcpkg packages
        uses: actions/cache@v4
        with:
          path: build/vcpkg_installed
          key: vcpkg-linux-clang-18-${{ hashFiles('vcpkg.json') }}
          restore-keys: vcpkg-linux-clang-18-

      - name: Bootstrap vcpkg
        run: ./vcpkg/bootstrap-vcpkg.sh

      - name: Configure
        run: >-
          cmake -B build -S .
          -G Ninja
          -DCMAKE_BUILD_TYPE=Debug
          -DCMAKE_TOOLCHAIN_FILE=vcpkg/scripts/buildsystems/vcpkg.cmake
          -DCMAKE_C_COMPILER_LAUNCHER=ccache
          -DCMAKE_CXX_COMPILER_LAUNCHER=ccache
          -DCMAKE_C_FLAGS="-fsanitize=address,undefined -fno-omit-frame-pointer"
          -DCMAKE_CXX_FLAGS="-fsanitize=address,undefined -fno-omit-frame-pointer"
          -DCMAKE_EXE_LINKER_FLAGS="-fsanitize=address,undefined"

      - name: Build
        run: cmake --build build

      - name: Unit tests
        run: >-
          ctest --test-dir build --output-on-failure
          -R "test_error|test_result|test_projection|test_transform"

      - name: Integration tests (Lavapipe + ASan)
        continue-on-error: true
        timeout-minutes: 10
        run: >-
          xvfb-run ctest --test-dir build --output-on-failure
          -E "test_error|test_result|test_projection|test_transform"

  # ── Thread Sanitizer (separate from ASan -- cannot combine) ───────
  thread-sanitizer:
    name: TSan
    runs-on: ubuntu-24.04
    env:
      CC: clang-18
      CXX: clang++-18
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Vulkan SDK
        uses: jakoch/install-vulkan-sdk-action@v1
        with:
          vulkan_version: ${{ env.VULKAN_SDK_VER }}
          cache: true
          stripdown: true

      - name: Install system dependencies
        run: >-
          sudo apt-get update && sudo apt-get install -y
          build-essential ninja-build clang-18
          autoconf autoconf-archive automake libtool pkg-config libltdl-dev
          libasound2-dev libpulse-dev libpipewire-0.3-dev
          libx11-dev libxext-dev libxrandr-dev libxcursor-dev
          libxfixes-dev libxi-dev libxss-dev libxkbcommon-dev
          libdrm-dev libgbm-dev libgl1-mesa-dev libgles2-mesa-dev
          libegl1-mesa-dev libdbus-1-dev libibus-1.0-dev
          libudev-dev libdecor-0-dev libwayland-dev libxtst-dev
          mesa-vulkan-drivers xvfb

      - name: Setup ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: linux-tsan

      - name: Restore vcpkg packages
        uses: actions/cache@v4
        with:
          path: build/vcpkg_installed
          key: vcpkg-linux-clang-18-${{ hashFiles('vcpkg.json') }}
          restore-keys: vcpkg-linux-clang-18-

      - name: Bootstrap vcpkg
        run: ./vcpkg/bootstrap-vcpkg.sh

      - name: Configure
        run: >-
          cmake -B build -S .
          -G Ninja
          -DCMAKE_BUILD_TYPE=Debug
          -DCMAKE_TOOLCHAIN_FILE=vcpkg/scripts/buildsystems/vcpkg.cmake
          -DCMAKE_C_COMPILER_LAUNCHER=ccache
          -DCMAKE_CXX_COMPILER_LAUNCHER=ccache
          -DCMAKE_C_FLAGS="-fsanitize=thread -fno-omit-frame-pointer"
          -DCMAKE_CXX_FLAGS="-fsanitize=thread -fno-omit-frame-pointer"
          -DCMAKE_EXE_LINKER_FLAGS="-fsanitize=thread"

      - name: Build
        run: cmake --build build

      - name: Unit tests
        run: >-
          ctest --test-dir build --output-on-failure
          -R "test_error|test_result|test_projection|test_transform"

      - name: Integration tests (Lavapipe + TSan)
        continue-on-error: true
        timeout-minutes: 15
        run: >-
          xvfb-run ctest --test-dir build --output-on-failure
          -E "test_error|test_result|test_projection|test_transform"

  # ── Code Coverage (GCC + gcov + lcov) ─────────────────────────────
  coverage:
    name: Code Coverage
    runs-on: ubuntu-24.04
    env:
      CC: gcc-14
      CXX: g++-14
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Vulkan SDK
        uses: jakoch/install-vulkan-sdk-action@v1
        with:
          vulkan_version: ${{ env.VULKAN_SDK_VER }}
          cache: true
          stripdown: true

      - name: Install system dependencies
        run: >-
          sudo apt-get update && sudo apt-get install -y
          build-essential ninja-build lcov
          autoconf autoconf-archive automake libtool pkg-config libltdl-dev
          libasound2-dev libpulse-dev libpipewire-0.3-dev
          libx11-dev libxext-dev libxrandr-dev libxcursor-dev
          libxfixes-dev libxi-dev libxss-dev libxkbcommon-dev
          libdrm-dev libgbm-dev libgl1-mesa-dev libgles2-mesa-dev
          libegl1-mesa-dev libdbus-1-dev libibus-1.0-dev
          libudev-dev libdecor-0-dev libwayland-dev libxtst-dev
          mesa-vulkan-drivers xvfb

      - name: Restore vcpkg packages
        uses: actions/cache@v4
        with:
          path: build/vcpkg_installed
          key: vcpkg-linux-gcc-14-${{ hashFiles('vcpkg.json') }}
          restore-keys: vcpkg-linux-gcc-14-

      - name: Bootstrap vcpkg
        run: ./vcpkg/bootstrap-vcpkg.sh

      - name: Configure
        run: >-
          cmake -B build -S .
          -G Ninja
          -DCMAKE_BUILD_TYPE=Debug
          -DCMAKE_TOOLCHAIN_FILE=vcpkg/scripts/buildsystems/vcpkg.cmake
          -DCMAKE_C_FLAGS="--coverage -fprofile-arcs -ftest-coverage"
          -DCMAKE_CXX_FLAGS="--coverage -fprofile-arcs -ftest-coverage"
          -DCMAKE_EXE_LINKER_FLAGS="--coverage"

      - name: Build
        run: cmake --build build

      - name: Run all tests (Lavapipe)
        continue-on-error: true
        run: xvfb-run ctest --test-dir build --output-on-failure

      - name: Generate coverage report
        run: |
          lcov --capture --directory build --output-file coverage.info \
            --gcov-tool gcov-14 \
            --ignore-errors mismatch --ignore-errors gcov
          lcov --remove coverage.info \
            '/usr/*' '*/vcpkg_installed/*' '*/tests/*' '*/examples/*' '*/third_party/*' \
            --output-file coverage.info --ignore-errors unused --ignore-errors empty
          lcov --list coverage.info --ignore-errors empty

      - name: Upload to Codecov
        if: env.CODECOV_TOKEN != ''
        uses: codecov/codecov-action@v5
        with:
          files: coverage.info
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  # ── Static Analysis (clang-tidy) ──────────────────────────────────
  clang-tidy:
    name: clang-tidy
    runs-on: ubuntu-24.04
    env:
      CC: clang-18
      CXX: clang++-18
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Vulkan SDK
        uses: jakoch/install-vulkan-sdk-action@v1
        with:
          vulkan_version: ${{ env.VULKAN_SDK_VER }}
          cache: true
          stripdown: true

      - name: Install system dependencies
        run: >-
          sudo apt-get update && sudo apt-get install -y
          build-essential ninja-build clang-18 clang-tidy-18
          autoconf autoconf-archive automake libtool pkg-config libltdl-dev
          libasound2-dev libpulse-dev libpipewire-0.3-dev
          libx11-dev libxext-dev libxrandr-dev libxcursor-dev
          libxfixes-dev libxi-dev libxss-dev libxkbcommon-dev
          libdrm-dev libgbm-dev libgl1-mesa-dev libgles2-mesa-dev
          libegl1-mesa-dev libdbus-1-dev libibus-1.0-dev
          libudev-dev libdecor-0-dev libwayland-dev libxtst-dev

      - name: Restore vcpkg packages
        uses: actions/cache@v4
        with:
          path: build/vcpkg_installed
          key: vcpkg-linux-clang-18-${{ hashFiles('vcpkg.json') }}
          restore-keys: vcpkg-linux-clang-18-

      - name: Bootstrap vcpkg
        run: ./vcpkg/bootstrap-vcpkg.sh

      - name: Configure
        run: >-
          cmake -B build -S .
          -G Ninja
          -DCMAKE_TOOLCHAIN_FILE=vcpkg/scripts/buildsystems/vcpkg.cmake
          -DVKSDL_BUILD_EXAMPLES=OFF
          -DCMAKE_CXX_CLANG_TIDY="clang-tidy-18"

      - name: Build (with clang-tidy)
        run: cmake --build build
